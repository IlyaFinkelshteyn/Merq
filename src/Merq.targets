<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<Import Project="$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildThisFileDirectory), NuGet.Restore.targets))\NuGet.Restore.targets"
			Condition=" '$(NuGetRestoreImported)' != 'true' " />

	<PropertyGroup>
		<ThisAssemblyNameFile Condition=" '$(Language)' == 'C#' ">$(IntermediateOutputPath)ThisAssembly.AssemblyName.g$(DefaultLanguageSourceExtension)</ThisAssemblyNameFile>
		<CompileDependsOn>
			ThisAssemblyName;
			$(CompileDependsOn)
		</CompileDependsOn>
		<BuildDependsOn Condition=" '$(BuildPackage)' == 'true' ">
			$(BuildDependsOn);
			BuildPackage
		</BuildDependsOn>
	</PropertyGroup>
	
	<Target Name="ThisAssemblyName" BeforeTargets="BuildOnlySettings" Condition=" '$(ThisAssemblyNameFile)' != '' " DependsOnTargets="GenerateThisAssemblyName">
		<ItemGroup>
			<Compile Include="$(ThisAssemblyNameFile)" />
		</ItemGroup>
	</Target>

	<Target Name="GenerateThisAssemblyName" Inputs="$(MSBuildProjectFullPath)" Outputs="$(ThisAssemblyNameFile)">
		<MakeDir Directories="$(IntermediateOutputPath)" Condition=" !Exists('$(IntermediateOutputPath)') " />
		<WriteLinesToFile Lines='partial class ThisAssembly
{
      /// &lt;summary&gt;AssemblyName: $(AssemblyName)&lt;/summary&gt;
      public const string AssemblyName = "$(AssemblyName)"%3B
}
' Overwrite='true' File='$(ThisAssemblyNameFile)' />

		<ItemGroup>
			<FileWrites Include="$(ThisAssemblyNameFile)" />
		</ItemGroup>
	</Target>

	<Target Name="GetVersion" DependsOnTargets="GitVersion" Returns="$(Version)">
		<PropertyGroup>
			<Version>$(GitSemVerMajor).$(GitSemVerMinor).$(GitSemVerPatch)$(GitSemVerDashLabel)</Version>
		</PropertyGroup>
	</Target>
	
	<Target Name="BuildPackage" DependsOnTargets="GetVersion" Inputs="$(TargetPath)" Outputs="$(Out)\$(MSBuildProjectName).$(Version).nupkg">
		<Error Condition=" !Exists('$(ProjectNuSpec)') " Text="BuildPackage is 'true' but no $([System.IO.Path]::GetFileName($(ProjectNuSpec))) found alongside project file." />
		<MakeDir Directories="$(Out)" Condition=" !Exists('$(Out)') " />
		<Exec Command='"$(NuGet)" Pack "$(ProjectNuSpec)" -Version $(Version) -Properties Id=$(MSBuildProjectName);Configuration=$(Configuration);Version=$(Version) -OutputDirectory $(Out)' />
	</Target>
	
</Project>